{"version":3,"sources":["webpack://@internetarchive/bookreader/./src/js/plugins/search/plugin.search.js","webpack://@internetarchive/bookreader/./src/js/plugins/search/view.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/array-for-each.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/array-last-index-of.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/engine-is-ios.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/host-report-errors.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/inherit-if-required.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/iterate.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/microtask.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/native-promise-constructor.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/new-promise-capability.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/perform.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/promise-resolve.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/set-species.js","webpack://@internetarchive/bookreader/./node_modules/core-js/internals/task.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.array.for-each.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.array.last-index-of.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.array.some.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.promise.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/es.regexp.constructor.js","webpack://@internetarchive/bookreader/./node_modules/core-js/modules/web.dom-collections.for-each.js"],"names":["super_","params","selector","this","br","matcher","RegExp","matches","cacheDOMElements","bindEvents","options","initialSearchTerm","setQuery","query","console","warn","dom","searchTray","renderSearchTray","results","querySelector","resultsCount","searchField","searchPending","mobileSearch","buildMobileDrawer","toolbarSearch","buildToolbarSearch","bool","classList","contains","toggle","innerText","toggleResultsCount","value","innerHTML","$","remove","removeSearchResults","removeResultPins","emptyMatches","teardownSearchNavigation","document","createElement","setAttribute","replace","before","resultsPosition","searchNavigation","positionMessage","length","currentMatchIndex","namespace","on","clearSearchFieldAndResults","bind","showPrevResult","showNextResult","mode","constModeThumb","switchMode","constMode1up","eq","click","updateResultsPosition","find","text","off","matchingSearchResult","constMode2up","find2upMatchingSearchResult","find1upMatchingSearchResult","indexOf","m","currentIndex","par","page","_isIndexDisplayed","setCurrentMatchIndex","items","map","match","leafNumToIndex","join","pinsVisibleState","refs","$BRfooter","css","visibility","imagesBaseURL","appendChild","add","forEach","queryString","pageIndex","pageNumber","getPageNum","percentThrough","constructor","util","cssPercentage","getNumLeafs","queryStringWithB","queryStringWithBTruncated","addClass","left","attr","append","data","appendTo","hover","event","marker","currentTarget","tooltip","tooltipOffset","getBoundingClientRect","targetOffset","boxSizeAdjust","parseInt","getComputedStyle","paddingLeft","x","style","setProperty","removeClass","target","_searchPluginGoToResult","updateSearchHilites","showProgressPopup","removeProgressPopup","renderModalMessage","delayModalRemovalFor","messageHTML","modal","el","timeoutMS","setTimeout","$mmenu","open","close","e","preventDefault","search","blur","toggleSearchPending","renderSearchNavigation","bindSearchNavigationEvents","renderMatches","renderPins","updateResultsCount","is_visible","navigationIsVisible","togglePinsFor","toggleSearchTray","removeSearchHilites","searchTerm","renderErrorModal","renderBookNotIndexedModal","renderResultsEmptyModal","handleSearchCallback","handleNavToggledCallback","handleSearchStarted","handleSearchCallbackError","handleSearchCallbackBookNotIndexed","handleSearchCallbackEmpty","updateSearchNavigation","addEventListener","submitHandler","dataset","closeMobileMenu","jQuery","extend","BookReader","defaultOptions","server","bookId","subPrefix","bookPath","enableSearch","searchInsideUrl","prototype","setup","call","searchResults","goToFirstResult","searchView","SearchView","init","suppressFragmentChange","buildMobileDrawerElement","$el","after","buildToolbarElement","term","overrides","disablePopup","error","success","trigger","eventNames","fragmentChange","serverPath","baseUrl","path","subPrefixWithSlash","lastIndexOf","substr","urlParams","item_id","doc","q","paramStr","param","url","processSearchResults","searchInsideResults","responseHasError","hasCustomError","hasCustomSuccess","BRSearchCallbackError","BRSearchCallback","ajax","dataType","then","instance","_BRSearchCallbackError","indexed","updateSearchHilites1UP","updateSearchHilites2UP","boxes","box","inArray","displayedIndices","div","prop","highlight","width","r","l","reduce","height","b","t","top","pageIsInView","isViewable","_models","book","getPage","$brTwoPageView","setHilightCss2UP","makeUnviewableAtEnd","fetch","URLSearchParams","id","subprefix","leafNum","json","resp","makeViewable","jumpToIndex","searchHighlightVisible","visiblePages","twoPage","currentIndexL","currentIndexR","some","$forEach","arrayMethodIsStrict","arrayMethodUsesToLength","STRICT_METHOD","USES_TO_LENGTH","module","exports","callbackfn","arguments","undefined","toIndexedObject","toInteger","toLength","min","Math","nativeLastIndexOf","NEGATIVE_ZERO","ACCESSORS","1","FORCED","searchElement","apply","O","index","userAgent","test","global","a","isObject","setPrototypeOf","$this","dummy","Wrapper","NewTarget","NewTargetPrototype","anObject","isArrayIteratorMethod","getIteratorMethod","callWithSafeIterationClosing","Result","stopped","result","iterable","fn","that","AS_ENTRIES","IS_ITERATOR","iterator","iterFn","next","step","boundFunction","TypeError","done","stop","flush","head","last","notify","node","promise","getOwnPropertyDescriptor","classof","macrotask","IS_IOS","MutationObserver","WebKitMutationObserver","process","Promise","IS_NODE","queueMicrotaskDescriptor","queueMicrotask","parent","domain","exit","enter","nextTick","createTextNode","observe","characterData","resolve","task","aFunction","PromiseCapability","C","reject","$$resolve","$$reject","f","exec","newPromiseCapability","promiseCapability","getBuiltIn","definePropertyModule","wellKnownSymbol","DESCRIPTORS","SPECIES","CONSTRUCTOR_NAME","Constructor","defineProperty","configurable","get","defer","channel","port","fails","html","location","set","setImmediate","clear","clearImmediate","MessageChannel","Dispatch","counter","queue","run","hasOwnProperty","runner","listener","post","postMessage","protocol","host","args","i","push","Function","now","port2","port1","onmessage","importScripts","removeChild","proto","forced","$some","Internal","OwnPromiseCapability","PromiseWrapper","nativeThen","IS_PURE","NativePromise","redefine","redefineAll","setToStringTag","setSpecies","anInstance","inspectSource","iterate","checkCorrectnessOfIteration","speciesConstructor","microtask","promiseResolve","hostReportErrors","newPromiseCapabilityModule","perform","InternalStateModule","isForced","V8_VERSION","PROMISE","getInternalState","setInternalState","getInternalPromiseState","getterFor","PromiseConstructor","$fetch","newGenericPromiseCapability","DISPATCH_EVENT","createEvent","dispatchEvent","UNHANDLED_REJECTION","String","PromiseRejectionEvent","FakePromise","INCORRECT_ITERATION","all","isThenable","it","state","isReject","notified","chain","reactions","ok","exited","reaction","handler","fail","rejection","onHandleUnhandled","onUnhandled","name","reason","initEvent","isUnhandled","emit","unwrap","internalReject","internalResolve","wrapper","executor","type","onFulfilled","onRejected","unsafe","enumerable","input","wrap","stat","capability","$promiseResolve","values","remaining","alreadyCalled","race","inheritIfRequired","getOwnPropertyNames","isRegExp","getFlags","stickyHelpers","MATCH","NativeRegExp","RegExpPrototype","re1","re2","CORRECT_NEW","UNSUPPORTED_Y","RegExpWrapper","pattern","flags","sticky","thisIsRegExp","patternIsRegExp","flagsAreUndefined","source","proxy","key","keys","DOMIterables","createNonEnumerableProperty","COLLECTION_NAME","Collection","CollectionPrototype"],"mappings":"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","file":"plugins/plugin.search.js","sourcesContent":["/* global BookReader */\r\n/**\r\n * Plugin for Archive.org book search\r\n * NOTE: This script must be loaded AFTER `plugin.mobile_nav.js`\r\n * as it mutates mobile nav drawer\r\n *\r\n * Events fired at various points throughout search processing are published\r\n * on the document DOM element. These can be subscribed to using jQuery's event\r\n * binding method `$.fn.on`. All of the events are prefixed with a BookReader\r\n * namespace. The events are:\r\n *\r\n * @event BookReader:SearchStarted - When a search form is submitted, immediately\r\n *   before an AJAX call is made to request search results\r\n * @event BookReader:SearchCallback - When the search AJAX call is returned and at\r\n *   least one result is returned. The event callback receives an object\r\n *   with the `results`, plugin `options`, and the BookReader `instance`\r\n * @event BookReader:SearchCallbackError - When the AJAX request returns an error.\r\n *   Receives the `results` and `instance`\r\n * @event BookReader:SearchCallbackNotIndexed - When a message is received that\r\n *   the book has not had OCR text indexed yet. Receives `instance`\r\n * @event BookReader:SearchCallbackEmpty - When no results found. Receives\r\n *   `instance`\r\n */\r\nimport SearchView from './view.js';\r\n\r\njQuery.extend(BookReader.defaultOptions, {\r\n  server: 'ia600609.us.archive.org',\r\n  bookId: '',\r\n  subPrefix: '',\r\n  bookPath: '',\r\n  enableSearch: true,\r\n  searchInsideUrl: '/fulltext/inside.php',\r\n  initialSearchTerm: null,\r\n});\r\n\r\n/** @override */\r\nBookReader.prototype.setup = (function (super_) {\r\n  return function (options) {\r\n    super_.call(this, options);\r\n\r\n    this.searchTerm = '';\r\n    this.searchResults = null;\r\n    this.searchInsideUrl = options.searchInsideUrl;\r\n    this.enableSearch = options.enableSearch;\r\n    this.goToFirstResult = false;\r\n\r\n    // Base server used by some api calls\r\n    this.bookId = options.bookId;\r\n    this.server = options.server;\r\n    this.subPrefix = options.subPrefix;\r\n    this.bookPath = options.bookPath;\r\n\r\n    if (this.searchView) { return; }\r\n    this.searchView = new SearchView({\r\n      br: this,\r\n      selector: '#BRsearch_tray',\r\n    });\r\n  };\r\n})(BookReader.prototype.setup);\r\n\r\n/** @override */\r\nBookReader.prototype.init = (function (super_) {\r\n  return function () {\r\n    super_.call(this);\r\n\r\n    if (this.options.enableSearch && this.options.initialSearchTerm) {\r\n      this.search(\r\n        this.options.initialSearchTerm,\r\n        { goToFirstResult: this.goToFirstResult, suppressFragmentChange: true }\r\n      );\r\n    }\r\n  };\r\n})(BookReader.prototype.init);\r\n\r\n/** @override */\r\nBookReader.prototype.buildMobileDrawerElement = (function (super_) {\r\n  return function () {\r\n    const $el = super_.call(this);\r\n    if (!this.enableSearch) { return; }\r\n    if (this.searchView.dom.mobileSearch) {\r\n      $el.find('.BRmobileMenu__moreInfoRow').after(this.searchView.dom.mobileSearch);\r\n    }\r\n    return $el;\r\n  };\r\n})(BookReader.prototype.buildMobileDrawerElement);\r\n\r\n/** @override */\r\nBookReader.prototype.buildToolbarElement = (function (super_) {\r\n  return function () {\r\n    const $el = super_.call(this);\r\n    if (!this.enableSearch) { return; }\r\n    if (this.searchView.dom.toolbarSearch) {\r\n      $el.find('.BRtoolbarSectionInfo').after(this.searchView.dom.toolbarSearch);\r\n    }\r\n    return $el;\r\n  };\r\n})(BookReader.prototype.buildToolbarElement);\r\n\r\n/**\r\n * @typedef {object} SearchOptions\r\n * @property {boolean} goToFirstResult\r\n * @property {boolean} disablePopup\r\n * @property {(null|function)} error - @deprecated at v.5.0\r\n * @property {(null|function)} success - @deprecated at v.5.0\r\n */\r\n\r\n/**\r\n * Submits search request\r\n *\r\n * @param {string} term\r\n * @param {SearchOptions} overrides\r\n */\r\nBookReader.prototype.search = function(term = '', overrides = {}) {\r\n  /** @type {SearchOptions} */\r\n  const defaultOptions = {\r\n    goToFirstResult: false, /* jump to the first result (default=false) */\r\n    disablePopup: false,    /* don't show the modal progress (default=false) */\r\n    suppressFragmentChange: false, /* don't change the URL on initial load */\r\n    error: null,            /* optional error handler (default=null) */\r\n    success: null,          /* optional success handler (default=null) */\r\n\r\n  };\r\n  const options = jQuery.extend({}, defaultOptions, overrides);\r\n  this.suppressFragmentChange = options.suppressFragmentChange;\r\n\r\n  // strip slashes, since this goes in the url\r\n  this.searchTerm = term.replace(/\\//g, ' ');\r\n\r\n  if (!options.suppressFragmentChange) {\r\n    this.trigger(BookReader.eventNames.fragmentChange);\r\n  }\r\n\r\n  // Add quotes to the term. This is to compenstate for the backends default OR query\r\n  // term = term.replace(/['\"]+/g, '');\r\n  // term = '\"' + term + '\"';\r\n\r\n  // Remove the port and userdir\r\n  const serverPath = this.server.replace(/:.+/, '');\r\n  const baseUrl = `https://${serverPath}${this.searchInsideUrl}?`;\r\n\r\n  // Remove subPrefix from end of path\r\n  let path = this.bookPath;\r\n  const subPrefixWithSlash = `/${this.subPrefix}`;\r\n  if (this.bookPath.length - this.bookPath.lastIndexOf(subPrefixWithSlash) == subPrefixWithSlash.length) {\r\n    path = this.bookPath.substr(0, this.bookPath.length - subPrefixWithSlash.length);\r\n  }\r\n\r\n  const urlParams = {\r\n    item_id: this.bookId,\r\n    doc: this.subPrefix,\r\n    path,\r\n    q: term,\r\n  };\r\n\r\n  // NOTE that the API does not expect / (slashes) to be encoded. (%2F) won't work\r\n  const paramStr = $.param(urlParams).replace(/%2F/g, '/');\r\n\r\n  const url = `${baseUrl}${paramStr}`;\r\n\r\n  const processSearchResults = (searchInsideResults) => {\r\n    const responseHasError = searchInsideResults.error || !searchInsideResults.matches.length;\r\n    const hasCustomError = typeof options.error === 'function';\r\n    const hasCustomSuccess = typeof options.success === 'function';\r\n\r\n    if (responseHasError) {\r\n      hasCustomError\r\n        ? options.error.call(this, searchInsideResults, options)\r\n        : this.BRSearchCallbackError(searchInsideResults, options);\r\n    } else {\r\n      hasCustomSuccess\r\n        ? options.success.call(this, searchInsideResults, options)\r\n        : this.BRSearchCallback(searchInsideResults, options);\r\n    }\r\n  };\r\n\r\n  this.trigger('SearchStarted');\r\n  return $.ajax({\r\n    url: url,\r\n    dataType: 'jsonp'\r\n  }).then(processSearchResults);\r\n};\r\n\r\n/**\r\n  * @typedef {object} SearchInsideMatchBox\r\n  * @property {number} page\r\n  * @property {number} r\r\n  * @property {number} l\r\n  * @property {number} b\r\n  * @property {number} t\r\n  * @property {HTMLDivElement} [div]\r\n  */\r\n\r\n/**\r\n * @typedef {object} SearchInsideMatch\r\n * @property {string} text\r\n * @property {Array<{ page: number, boxes: SearchInsideMatchBox[] }>} par\r\n */\r\n\r\n/**\r\n * @typedef {object} SearchInsideResults\r\n * @property {string} error\r\n * @property {SearchInsideMatch[]} matches\r\n * @property {boolean} indexed\r\n */\r\n\r\n/**\r\n * Search Results return handler\r\n * @callback\r\n * @param {SearchInsideResults} results\r\n * @param {object} options\r\n * @param {boolean} options.goToFirstResult\r\n */\r\nBookReader.prototype.BRSearchCallback = function(results, options) {\r\n  this.searchResults = results;\r\n\r\n  this.updateSearchHilites();\r\n  this.removeProgressPopup();\r\n  if (options.goToFirstResult) {\r\n    this._searchPluginGoToResult(results.matches[0].par[0].page);\r\n  }\r\n  this.trigger('SearchCallback', { results, options, instance: this });\r\n}\r\n\r\n/**\r\n * Main search results error handler\r\n * @callback\r\n * @param {SearchInsideResults} results\r\n */\r\nBookReader.prototype.BRSearchCallbackError = function(results) {\r\n  this._BRSearchCallbackError(results);\r\n};\r\n\r\n/**\r\n * @private draws search results error\r\n * @callback\r\n * @param {SearchInsideResults} results\r\n * @param {jQuery} $el\r\n * @param {boolean} fade\r\n */\r\nBookReader.prototype._BRSearchCallbackError = function(results) {\r\n  this.searchResults = results;\r\n  if (results.error) {\r\n    this.trigger('SearchCallbackError', { results, instance: this });\r\n  } else if (0 == results.matches.length) {\r\n    if (false === results.indexed) {\r\n      this.trigger('SearchCallbackBookNotIndexed', { instance: this });\r\n      return;\r\n    }\r\n    this.trigger('SearchCallbackEmpty', { instance: this });\r\n  }\r\n};\r\n\r\n/**\r\n * updates search on-page highlights controller\r\n */\r\nBookReader.prototype.updateSearchHilites = function() {\r\n  if (this.constMode2up == this.mode) {\r\n    this.updateSearchHilites2UP();\r\n    return;\r\n  }\r\n  this.updateSearchHilites1UP();\r\n};\r\n\r\n/**\r\n * update search on-page highlights in 1up mode\r\n */\r\nBookReader.prototype.updateSearchHilites1UP = function() {\r\n  const results = this.searchResults;\r\n  if (null == results) return;\r\n  results.matches.forEach(match => {\r\n    match.par[0].boxes.forEach(box => {\r\n      const pageIndex = this.leafNumToIndex(box.page);\r\n      const pageIsInView = jQuery.inArray(pageIndex, this.displayedIndices) >= 0;\r\n      if (pageIsInView) {\r\n        if (!box.div) {\r\n          //create a div for the search highlight, and stash it in the box object\r\n          box.div = document.createElement('div');\r\n          $(box.div).prop('className', 'BookReaderSearchHilite').appendTo(this.$(`.pagediv${pageIndex}`));\r\n        }\r\n        const highlight = {\r\n          width:  `${(box.r - box.l) / this.reduce}px`,\r\n          height: `${(box.b - box.t) / this.reduce}px`,\r\n          left:   `${(box.l) / this.reduce}px`,\r\n          top:    `${(box.t) / this.reduce}px`\r\n        };\r\n        $(box.div).css(highlight);\r\n      } else {\r\n        if (box.div) {\r\n          $(box.div).remove();\r\n          box.div = null;\r\n        }\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * update search on-page highlights in 2up mode\r\n */\r\nBookReader.prototype.updateSearchHilites2UP = function() {\r\n  const results = this.searchResults;\r\n\r\n  if (results === null) return;\r\n\r\n  const { matches } = results;\r\n  matches.forEach((match) => {\r\n    match.par[0].boxes.forEach(box => {\r\n      const pageIndex = this.leafNumToIndex(match.par[0].page);\r\n      const pageIsInView = jQuery.inArray(pageIndex, this.displayedIndices) >= 0;\r\n      const { isViewable } = this._models.book.getPage(pageIndex);\r\n\r\n      if (pageIsInView && isViewable) {\r\n        if (!box.div) {\r\n          //create a div for the search highlight, and stash it in the box object\r\n          box.div = document.createElement('div');\r\n          $(box.div).addClass('BookReaderSearchHilite')\r\n            .appendTo(this.refs.$brTwoPageView);\r\n        }\r\n        this.setHilightCss2UP(box.div, pageIndex, box.l, box.r, box.t, box.b);\r\n      } else {\r\n        // clear stale reference\r\n        if (box.div) {\r\n          $(box.div).remove();\r\n          box.div = null;\r\n        }\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * remove search highlights\r\n */\r\nBookReader.prototype.removeSearchHilites = function() {\r\n  const results = this.searchResults;\r\n  if (null == results) return;\r\n  results.matches.forEach(match => {\r\n    match.par[0].boxes.forEach(box => {\r\n      if (null != box.div) {\r\n        $(box.div).remove();\r\n        box.div = null;\r\n      }\r\n    });\r\n  });\r\n};\r\n\r\n/**\r\n * @private\r\n * Goes to the page specified. If the page is not viewable, tries to load the page\r\n * FIXME Most of this logic is IA specific, and should be less integrated into here\r\n * or at least more configurable.\r\n * @param {PageIndex} pageIndex\r\n */\r\nBookReader.prototype._searchPluginGoToResult = async function (pageIndex) {\r\n  const { book } = this._models;\r\n  const page = book.getPage(pageIndex);\r\n  let makeUnviewableAtEnd = false;\r\n  if (!page.isViewable) {\r\n    const resp = await fetch('/services/bookreader/request_page?' + new URLSearchParams({\r\n      id: this.options.bookId,\r\n      subprefix: this.options.subPrefix,\r\n      leafNum: page.leafNum,\r\n    })).then(r => r.json());\r\n\r\n    for (const leafNum of resp.value) {\r\n      book.getPage(book.leafNumToIndex(leafNum)).makeViewable();\r\n    }\r\n\r\n    // not able to show page; make the page viewable anyways so that it can\r\n    // actually open. On IA, it has a fallback to a special error page.\r\n    if (!resp.value.length) {\r\n      book.getPage(pageIndex).makeViewable();\r\n      makeUnviewableAtEnd = true;\r\n    }\r\n  }\r\n  this.jumpToIndex(pageIndex);\r\n\r\n  // Reset it to unviewable if it wasn't resolved\r\n  if (makeUnviewableAtEnd) {\r\n    book.getPage(pageIndex).makeViewable(false);\r\n  }\r\n};\r\n\r\n/**\r\n * Removes all search pins\r\n */\r\nBookReader.prototype.removeSearchResults = function(suppressFragmentChange = false) {\r\n  this.removeSearchHilites(); //be sure to set all box.divs to null\r\n  this.searchTerm = null;\r\n  this.searchResults = null;\r\n  if (!suppressFragmentChange) {\r\n    this.trigger(BookReader.eventNames.fragmentChange);\r\n  }\r\n};\r\n\r\n/**\r\n * Returns true if a search highlight is currently being displayed\r\n * @returns {boolean}\r\n */\r\nBookReader.prototype.searchHighlightVisible = function() {\r\n  const results = this.searchResults;\r\n  let visiblePages = [];\r\n  if (null == results) return false;\r\n\r\n  if (this.constMode2up == this.mode) {\r\n    visiblePages = [this.twoPage.currentIndexL, this.twoPage.currentIndexR];\r\n  } else if (this.constMode1up == this.mode) {\r\n    visiblePages = [this.currentIndex()];\r\n  } else {\r\n    return false;\r\n  }\r\n\r\n  results.matches.some(match => {\r\n    return match.par[0].boxes.some(box => {\r\n      const pageIndex = this.leafNumToIndex(box.page);\r\n      if (jQuery.inArray(pageIndex, visiblePages) >= 0) {\r\n        return true;\r\n      }\r\n    });\r\n  });\r\n\r\n  return false;\r\n};\r\n","class SearchView {\r\n  /**\r\n   * @param {object} params\r\n   *   @param {string} params.selector A selector for the element that the search tray will be rendered in\r\n   *   @param {string} params.query An existing query string\r\n   *   @param {object} params.br The BookReader instance\r\n   */\r\n  constructor(params) {\r\n    if (!params.selector) {\r\n      console.warn('BookReader::Search - SearchView must be passed a valid CSS selector');\r\n      return;\r\n    }\r\n\r\n    this.br = params.br;\r\n\r\n    // Search results are returned as a text blob with the hits wrapped in\r\n    // triple mustaches. Hits occasionally include text beyond the search\r\n    // term, so everything within the staches is captured and wrapped.\r\n    this.matcher = new RegExp('{{{(.+?)}}}', 'g');\r\n    this.matches = [];\r\n    this.cacheDOMElements(params.selector);\r\n    this.bindEvents();\r\n\r\n    if (this.br.options.initialSearchTerm) {\r\n      this.setQuery(params.query);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @param {string} selector A selector for the element that the search tray will be rendered in\r\n   */\r\n  cacheDOMElements(selector) {\r\n    this.dom = {};\r\n\r\n    // The parent search tray in mobile menu\r\n    this.dom.searchTray = this.renderSearchTray(selector);\r\n    // Container for rendered search results\r\n    this.dom.results = this.dom.searchTray.querySelector('[data-id=\"results\"]');\r\n    // Element used to display number of results\r\n    this.dom.resultsCount = this.dom.searchTray.querySelector('[data-id=\"results_count\"]');\r\n    // Search input within the mobile search tray\r\n    this.dom.searchField = this.dom.searchTray.querySelector('[name=\"query\"]');\r\n    // Waiting indicator displayed while waiting for a search request\r\n    this.dom.searchPending = this.dom.searchTray.querySelector('[data-id=\"searchPending\"]');\r\n    // The element added to the mobile menu that is animated into view when\r\n    // the \"search\" nav item is clicked\r\n    this.dom.mobileSearch = this.buildMobileDrawer();\r\n    // Search input within the top toolbar. Will be removed once the mobile menu is replaced.\r\n    this.dom.toolbarSearch = this.buildToolbarSearch();\r\n  }\r\n\r\n  /**\r\n   * @param {boolean} bool\r\n   */\r\n  toggleSearchTray(bool = this.dom.searchTray.classList.contains('hidden')) {\r\n    this.dom.searchTray.classList.toggle('hidden', !bool);\r\n  }\r\n\r\n  /**\r\n   * @param {boolean} bool\r\n   */\r\n  toggleResultsCount(bool) {\r\n    this.dom.resultsCount.classList.toggle('visible', bool);\r\n  }\r\n\r\n  /**\r\n   * @param {SearchInsideResults} results\r\n   */\r\n  updateResultsCount(results) {\r\n    this.dom.resultsCount.innerText = `(${results} result${results != 1 ? 's' : ''})`;\r\n    this.toggleResultsCount(true);\r\n  }\r\n\r\n  /**\r\n   * @param {string} query\r\n   */\r\n  setQuery(query) {\r\n    this.dom.searchField.value = query;\r\n  }\r\n\r\n  emptyMatches() {\r\n    this.dom.results.innerHTML = '';\r\n    this.matches = [];\r\n  }\r\n\r\n  removeResultPins() {\r\n    this.br.$('.BRnavpos .BRsearch').remove();\r\n  }\r\n\r\n  clearSearchFieldAndResults() {\r\n    this.br.removeSearchResults();\r\n    this.toggleResultsCount(false);\r\n    this.removeResultPins();\r\n    this.emptyMatches();\r\n    this.setQuery('');\r\n    this.teardownSearchNavigation();\r\n  }\r\n\r\n  /**\r\n   * @param {string} selector The ID attribute to be used for the search tray\r\n   */\r\n  renderSearchTray(selector) {\r\n    const searchTray = document.createElement('div');\r\n    searchTray.setAttribute('id', selector.replace(/^#/, ''));\r\n    searchTray.innerHTML = `\r\n      <header>\r\n        <div>\r\n          <h3>Search inside</h3>\r\n          <p data-id=\"results_count\"></p>\r\n        </div>\r\n        <a href=\"#\" class=\"close\"></a>\r\n      </header>\r\n      <form action=\"\" method=\"get\">\r\n        <fieldset>\r\n          <input name=\"all_files\" id=\"all_files\" type=\"checkbox\" />\r\n          <label class=\"checkbox\" for=\"all_files\">Search all files</label>\r\n          <input type=\"search\" name=\"query\" placeholder=\"Enter a search term\" />\r\n        </fieldset>\r\n      </form>\r\n      <div data-id=\"searchPending\" id=\"search_pending\">\r\n        <p>Your search results will appear below</p>\r\n        <div class=\"loader tc mt20\"></div>\r\n      </div>\r\n      <ul data-id=\"results\"></ul>\r\n    `;\r\n    return searchTray;\r\n  }\r\n\r\n  renderSearchNavigation() {\r\n    const selector = 'BRsearch-navigation';\r\n    $('.BRnav').before(`\r\n      <div class=\"${selector}\">\r\n        <h4>\r\n          <span class=\"icon icon-search\"></span>\r\n          Results\r\n        </h4>\r\n        <div class=\"pagination\">\r\n          <a href=\"#\" class=\"prev\" title=\"Previous result\"><span class=\"icon icon-chevron hflip\"></span></a>\r\n          <span data-id=\"resultsCount\">${this.resultsPosition()}</span>\r\n          <a href=\"#\" class=\"next\" title=\"Next result\"><span class=\"icon icon-chevron\"></a>\r\n        </div>\r\n        <a href=\"#\" class=\"clear\" title=\"Clear search results\">\r\n          <span class=\"icon icon-close\"></span>\r\n        </a>\r\n      </div>\r\n    `);\r\n    this.dom.searchNavigation = $(`.${selector}`);\r\n  }\r\n\r\n  resultsPosition() {\r\n    let positionMessage = `${this.matches.length} result${this.matches.length === 1 ? '' : 's'}`;\r\n    if (~this.currentMatchIndex) {\r\n      positionMessage = `${this.currentMatchIndex + 1} / ${this.matches.length}`;\r\n    }\r\n    return positionMessage;\r\n  }\r\n\r\n  bindSearchNavigationEvents() {\r\n    if (!this.dom.searchNavigation) { return; }\r\n    const namespace = 'searchNavigation';\r\n\r\n    this.dom.searchNavigation\r\n      .on(`click.${namespace}`, '.clear', this.clearSearchFieldAndResults.bind(this))\r\n      .on(`click.${namespace}`, '.prev', this.showPrevResult.bind(this))\r\n      .on(`click.${namespace}`, '.next', this.showNextResult.bind(this))\r\n      .on(`click.${namespace}`, false);\r\n  }\r\n\r\n  showPrevResult() {\r\n    if (this.currentMatchIndex === 0) { return; }\r\n    if (this.br.mode === this.br.constModeThumb) { this.br.switchMode(this.br.constMode1up); }\r\n    if (!~this.currentMatchIndex) { this.currentMatchIndex = 1; }\r\n    this.br.$('.BRnavline .BRsearch').eq(--this.currentMatchIndex).click();\r\n    this.updateResultsPosition();\r\n  }\r\n\r\n  showNextResult() {\r\n    if (this.currentMatchIndex + 1 === this.matches.length) { return; }\r\n    if (this.br.mode === this.br.constModeThumb) { this.br.switchMode(this.br.constMode1up); }\r\n    this.br.$('.BRnavline .BRsearch').eq(++this.currentMatchIndex).click();\r\n    this.updateResultsPosition();\r\n  }\r\n\r\n  updateResultsPosition() {\r\n    this.dom.searchNavigation.find('[data-id=resultsCount]').text(this.resultsPosition());\r\n  }\r\n\r\n  teardownSearchNavigation() {\r\n    if (!this.dom.searchNavigation) {\r\n      this.dom.searchNavigation = $('.BRsearch-navigation');\r\n    }\r\n    if (!this.dom.searchNavigation.length) { return; }\r\n\r\n    this.dom.searchNavigation.off('.searchNavigation').remove();\r\n    this.dom.searchNavigation = null;\r\n  }\r\n\r\n  setCurrentMatchIndex() {\r\n    let matchingSearchResult;\r\n    if (this.br.mode === this.br.constModeThumb) {\r\n      this.currentMatchIndex = -1;\r\n      return;\r\n    }\r\n    if (this.br.mode === this.br.constMode2up) {\r\n      matchingSearchResult = this.find2upMatchingSearchResult();\r\n    }\r\n    else {\r\n      matchingSearchResult = this.find1upMatchingSearchResult();\r\n    }\r\n    this.currentMatchIndex = this.matches.indexOf(matchingSearchResult);\r\n  }\r\n\r\n  find1upMatchingSearchResult() {\r\n    return this.matches.find((m) => this.br.currentIndex() === m.par[0].page - 1);\r\n  }\r\n\r\n  find2upMatchingSearchResult() {\r\n    return this.matches.find((m) => this.br._isIndexDisplayed(m.par[0].page - 1));\r\n  }\r\n\r\n  updateSearchNavigation() {\r\n    if (!this.matches.length) { return; }\r\n\r\n    this.setCurrentMatchIndex();\r\n    this.updateResultsPosition();\r\n  }\r\n\r\n  /**\r\n   * @param {array} matches\r\n   */\r\n  renderMatches(matches) {\r\n    const items = matches.map((match) => `\r\n      <li data-page=\"${match.par[0].page}\" data-page-index=\"${this.br.leafNumToIndex(match.par[0].page)}\">\r\n        <h4>Page ${match.par[0].page}</h4>\r\n        <p>${match.text.replace(this.matcher, '<mark>$1</mark>')}</p>\r\n      </li>\r\n    `);\r\n    this.dom.results.innerHTML = items.join('');\r\n  }\r\n\r\n  /**\r\n   * @param {boolean} bool\r\n   */\r\n  togglePinsFor(bool) {\r\n    const pinsVisibleState = bool ? 'visible' : 'hidden';\r\n    this.br.refs.$BRfooter.find('.BRsearch').css({ visibility: pinsVisibleState });\r\n  }\r\n\r\n  buildMobileDrawer() {\r\n    const mobileSearch = document.createElement('li');\r\n    mobileSearch.innerHTML = `\r\n      <span>\r\n        <span class=\"DrawerIconWrapper\">\r\n          <img class=\"DrawerIcon\" src=\"${this.br.imagesBaseURL}icon_search_button.svg\" />\r\n        </span>\r\n        Search\r\n      </span>\r\n      <div data-id=\"search_slot\">\r\n      </div>\r\n    `;\r\n    mobileSearch.querySelector('[data-id=\"search_slot\"]').appendChild(this.dom.searchTray);\r\n    mobileSearch.classList.add('BRmobileMenu__search');\r\n    return mobileSearch;\r\n  }\r\n\r\n  buildToolbarSearch() {\r\n    const toolbarSearch = document.createElement('span');\r\n    toolbarSearch.classList.add('BRtoolbarSection', 'BRtoolbarSectionSearch');\r\n    toolbarSearch.innerHTML = `\r\n      <form class=\"BRbooksearch desktop\">\r\n        <input type=\"search\" name=\"query\" class=\"BRsearchInput\" val=\"\" placeholder=\"Search inside\"/>\r\n        <button type=\"submit\" class=\"BRsearchSubmit\">\r\n          <img src=\"${this.br.imagesBaseURL}icon_search_button.svg\" />\r\n        </button>\r\n      </form>\r\n    `;\r\n    return toolbarSearch;\r\n  }\r\n\r\n  /**\r\n   * @param {array} matches\r\n   */\r\n  renderPins(matches) {\r\n    matches.forEach((match) => {\r\n      const queryString = match.text;\r\n      const pageIndex = this.br.leafNumToIndex(match.par[0].page);\r\n      const pageNumber = this.br.getPageNum(pageIndex);\r\n      const uiStringSearch = \"Search result\"; // i18n\r\n      const uiStringPage = \"Page\"; // i18n\r\n\r\n      const percentThrough = this.br.constructor.util.cssPercentage(pageIndex, this.br.getNumLeafs() - 1);\r\n\r\n      const queryStringWithB = queryString.replace(this.matcher, '<b>$1</b>');\r\n\r\n      let queryStringWithBTruncated = '';\r\n\r\n      if (queryString.length > 100) {\r\n        queryStringWithBTruncated = queryString\r\n          .replace(/^(.{100}[^\\s]*).*/, \"$1\")\r\n          .replace(this.matcher, '<b>$1</b>')\r\n                + '...';\r\n      }\r\n\r\n      // draw marker\r\n      $('<div>')\r\n        .addClass('BRsearch')\r\n        .css({\r\n          left: percentThrough,\r\n        })\r\n        .attr('title', uiStringSearch)\r\n        .append(`\r\n          <div class=\"BRquery\">\r\n            <div>${queryStringWithBTruncated || queryStringWithB}</div>\r\n            <div>${uiStringPage} ${pageNumber}</div>\r\n          </div>\r\n        `)\r\n        .data({ pageIndex })\r\n        .appendTo(this.br.$('.BRnavline'))\r\n        .hover(\r\n          (event) => {\r\n            // remove from other markers then turn on just for this\r\n            // XXX should be done when nav slider moves\r\n            const marker = event.currentTarget;\r\n            const tooltip = marker.querySelector('.BRquery');\r\n            const tooltipOffset = tooltip.getBoundingClientRect();\r\n            const targetOffset = marker.getBoundingClientRect();\r\n            const boxSizeAdjust = parseInt(getComputedStyle(tooltip).paddingLeft) * 2;\r\n            if (tooltipOffset.x - boxSizeAdjust < 0) {\r\n              tooltip.style.setProperty('transform', `translateX(-${targetOffset.left - boxSizeAdjust}px)`);\r\n            }\r\n            $('.BRsearch,.BRchapter').removeClass('front');\r\n            $(event.target).addClass('front');\r\n          },\r\n          (event) => $(event.target).removeClass('front'))\r\n        .click(function (event) {\r\n          // closures are nested and deep, using an arrow function breaks references.\r\n          // Todo: update to arrow function & clean up closures\r\n          // to remove `bind` dependency\r\n          this.br._searchPluginGoToResult(+$(event.target).data('pageIndex'));\r\n          this.br.updateSearchHilites();\r\n        }.bind(this));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * @param {boolean} bool\r\n   */\r\n  toggleSearchPending(bool) {\r\n    this.dom.searchPending.classList.toggle('visible', bool);\r\n    if (bool) {\r\n      this.br.showProgressPopup(\r\n        `<img class=\"searchmarker\" src=\"${this.br.imagesBaseURL}marker_srch-on.svg\" />\r\n        Search results will appear below...`\r\n      );\r\n    }\r\n    else {\r\n      this.br.removeProgressPopup();\r\n    }\r\n  }\r\n\r\n  renderErrorModal() {\r\n    this.renderModalMessage('Sorry, there was an error with your search.<br />The text may still be processing.');\r\n    this.delayModalRemovalFor(4000);\r\n  }\r\n\r\n  renderBookNotIndexedModal() {\r\n    this.renderModalMessage(`\r\n      <p>\r\n         This book hasn't been indexed for searching yet.\r\n         We've just started indexing it, so search should be available soon.\r\n         Please try again later. Thanks!\r\n      </p>\r\n    `);\r\n    this.delayModalRemovalFor(5000);\r\n  }\r\n\r\n  renderResultsEmptyModal() {\r\n    this.renderModalMessage('No matches were found.');\r\n    this.delayModalRemovalFor(2000);\r\n  }\r\n\r\n  /**\r\n   * @param {string} messageHTML The innerHTML string used to popupate the modal contents\r\n   */\r\n  renderModalMessage(messageHTML) {\r\n    const modal = document.createElement('div');\r\n    modal.classList.add('BRprogresspopup', 'search_modal');\r\n    modal.innerHTML = messageHTML;\r\n    document.querySelector(this.br.el).append(modal);\r\n  }\r\n\r\n  /**\r\n   * @param {number} timeoutMS\r\n   */\r\n  delayModalRemovalFor(timeoutMS) {\r\n    setTimeout(this.br.removeProgressPopup.bind(this.br), timeoutMS);\r\n  }\r\n\r\n  openMobileMenu() {\r\n    this.br.refs.$mmenu.data('mmenu').open();\r\n  }\r\n\r\n  closeMobileMenu() {\r\n    this.br.refs.$mmenu.data('mmenu').close();\r\n  }\r\n\r\n  /**\r\n   * @param {Event} e\r\n   */\r\n  submitHandler(e) {\r\n    e.preventDefault();\r\n    const query = e.target.querySelector('[name=\"query\"]').value;\r\n    if (!query.length) { return false; }\r\n    this.br.search(query);\r\n    this.dom.searchField.blur();\r\n    this.emptyMatches();\r\n    this.toggleSearchPending(true);\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * @param {Event} e\r\n   * @param {object} properties\r\n   *   @param {object} properties.results\r\n   */\r\n  handleSearchCallback(e, { results }) {\r\n    this.matches = results.matches;\r\n    this.setCurrentMatchIndex();\r\n    this.teardownSearchNavigation();\r\n    this.renderSearchNavigation();\r\n    this.bindSearchNavigationEvents();\r\n    this.renderMatches(results.matches);\r\n    this.renderPins(results.matches);\r\n    this.updateResultsCount(results.matches.length);\r\n    this.toggleSearchPending(false);\r\n  }\r\n\r\n  /**\r\n   * @param {Event} e\r\n   */\r\n  handleNavToggledCallback(e) {\r\n    const is_visible = this.br.navigationIsVisible();\r\n    this.togglePinsFor(is_visible);\r\n    this.toggleSearchTray(is_visible ? !!this.dom.results.querySelector('li') : false);\r\n  }\r\n\r\n  handleSearchStarted() {\r\n    this.br.removeSearchHilites();\r\n    this.removeResultPins();\r\n    this.toggleSearchPending(true);\r\n    this.teardownSearchNavigation();\r\n    this.setQuery(this.br.searchTerm);\r\n  }\r\n\r\n  handleSearchCallbackError() {\r\n    this.toggleSearchPending(false);\r\n    this.renderErrorModal();\r\n  }\r\n\r\n  handleSearchCallbackBookNotIndexed() {\r\n    this.toggleSearchPending(false);\r\n    this.renderBookNotIndexedModal();\r\n  }\r\n\r\n  handleSearchCallbackEmpty() {\r\n    this.toggleSearchPending(false);\r\n    this.renderResultsEmptyModal();\r\n  }\r\n\r\n  bindEvents() {\r\n    const namespace = 'BookReader:';\r\n\r\n    $(document).on(`${namespace}SearchCallback`, this.handleSearchCallback.bind(this))\r\n      .on(`${namespace}navToggled`, this.handleNavToggledCallback.bind(this))\r\n      .on(`${namespace}SearchStarted`, this.handleSearchStarted.bind(this))\r\n      .on(`${namespace}SearchCallbackError`, this.handleSearchCallbackError.bind(this))\r\n      .on(`${namespace}SearchCallbackBookNotIndexed`, this.handleSearchCallbackBookNotIndexed.bind(this))\r\n      .on(`${namespace}SearchCallbackEmpty`, this.handleSearchCallbackEmpty.bind(this))\r\n      .on(`${namespace}pageChanged`, this.updateSearchNavigation.bind(this));\r\n\r\n    this.dom.searchTray.addEventListener('submit', this.submitHandler.bind(this));\r\n    this.dom.toolbarSearch.querySelector('form').addEventListener('submit', this.submitHandler.bind(this));\r\n    this.dom.searchField.addEventListener('search', () => {\r\n      if (this.dom.searchField.value) { return; }\r\n      this.clearSearchFieldAndResults();\r\n    });\r\n\r\n    $(this.dom.results).on('click', 'li', (e) => {\r\n      this.br._searchPluginGoToResult(+e.currentTarget.dataset.pageIndex);\r\n      this.br.updateSearchHilites();\r\n      this.closeMobileMenu();\r\n    });\r\n  }\r\n}\r\n\r\nexport default SearchView;\r\n","'use strict';\nvar $forEach = require('../internals/array-iteration').forEach;\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar arrayMethodUsesToLength = require('../internals/array-method-uses-to-length');\n\nvar STRICT_METHOD = arrayMethodIsStrict('forEach');\nvar USES_TO_LENGTH = arrayMethodUsesToLength('forEach');\n\n// `Array.prototype.forEach` method implementation\n// https://tc39.github.io/ecma262/#sec-array.prototype.foreach\nmodule.exports = (!STRICT_METHOD || !USES_TO_LENGTH) ? function forEach(callbackfn /* , thisArg */) {\n  return $forEach(this, callbackfn, arguments.length > 1 ? arguments[1] : undefined);\n} : [].forEach;\n","'use strict';\nvar toIndexedObject = require('../internals/to-indexed-object');\nvar toInteger = require('../internals/to-integer');\nvar toLength = require('../internals/to-length');\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar arrayMethodUsesToLength = require('../internals/array-method-uses-to-length');\n\nvar min = Math.min;\nvar nativeLastIndexOf = [].lastIndexOf;\nvar NEGATIVE_ZERO = !!nativeLastIndexOf && 1 / [1].lastIndexOf(1, -0) < 0;\nvar STRICT_METHOD = arrayMethodIsStrict('lastIndexOf');\n// For preventing possible almost infinite loop in non-standard implementations, test the forward version of the method\nvar USES_TO_LENGTH = arrayMethodUsesToLength('indexOf', { ACCESSORS: true, 1: 0 });\nvar FORCED = NEGATIVE_ZERO || !STRICT_METHOD || !USES_TO_LENGTH;\n\n// `Array.prototype.lastIndexOf` method implementation\n// https://tc39.github.io/ecma262/#sec-array.prototype.lastindexof\nmodule.exports = FORCED ? function lastIndexOf(searchElement /* , fromIndex = @[*-1] */) {\n  // convert -0 to +0\n  if (NEGATIVE_ZERO) return nativeLastIndexOf.apply(this, arguments) || 0;\n  var O = toIndexedObject(this);\n  var length = toLength(O.length);\n  var index = length - 1;\n  if (arguments.length > 1) index = min(index, toInteger(arguments[1]));\n  if (index < 0) index = length + index;\n  for (;index >= 0; index--) if (index in O && O[index] === searchElement) return index || 0;\n  return -1;\n} : nativeLastIndexOf;\n","var userAgent = require('../internals/engine-user-agent');\n\nmodule.exports = /(iphone|ipod|ipad).*applewebkit/i.test(userAgent);\n","var global = require('../internals/global');\n\nmodule.exports = function (a, b) {\n  var console = global.console;\n  if (console && console.error) {\n    arguments.length === 1 ? console.error(a) : console.error(a, b);\n  }\n};\n","var isObject = require('../internals/is-object');\nvar setPrototypeOf = require('../internals/object-set-prototype-of');\n\n// makes subclassing work correct for wrapped built-ins\nmodule.exports = function ($this, dummy, Wrapper) {\n  var NewTarget, NewTargetPrototype;\n  if (\n    // it can work only with native `setPrototypeOf`\n    setPrototypeOf &&\n    // we haven't completely correct pre-ES6 way for getting `new.target`, so use this\n    typeof (NewTarget = dummy.constructor) == 'function' &&\n    NewTarget !== Wrapper &&\n    isObject(NewTargetPrototype = NewTarget.prototype) &&\n    NewTargetPrototype !== Wrapper.prototype\n  ) setPrototypeOf($this, NewTargetPrototype);\n  return $this;\n};\n","var anObject = require('../internals/an-object');\nvar isArrayIteratorMethod = require('../internals/is-array-iterator-method');\nvar toLength = require('../internals/to-length');\nvar bind = require('../internals/function-bind-context');\nvar getIteratorMethod = require('../internals/get-iterator-method');\nvar callWithSafeIterationClosing = require('../internals/call-with-safe-iteration-closing');\n\nvar Result = function (stopped, result) {\n  this.stopped = stopped;\n  this.result = result;\n};\n\nvar iterate = module.exports = function (iterable, fn, that, AS_ENTRIES, IS_ITERATOR) {\n  var boundFunction = bind(fn, that, AS_ENTRIES ? 2 : 1);\n  var iterator, iterFn, index, length, result, next, step;\n\n  if (IS_ITERATOR) {\n    iterator = iterable;\n  } else {\n    iterFn = getIteratorMethod(iterable);\n    if (typeof iterFn != 'function') throw TypeError('Target is not iterable');\n    // optimisation for array iterators\n    if (isArrayIteratorMethod(iterFn)) {\n      for (index = 0, length = toLength(iterable.length); length > index; index++) {\n        result = AS_ENTRIES\n          ? boundFunction(anObject(step = iterable[index])[0], step[1])\n          : boundFunction(iterable[index]);\n        if (result && result instanceof Result) return result;\n      } return new Result(false);\n    }\n    iterator = iterFn.call(iterable);\n  }\n\n  next = iterator.next;\n  while (!(step = next.call(iterator)).done) {\n    result = callWithSafeIterationClosing(iterator, boundFunction, step.value, AS_ENTRIES);\n    if (typeof result == 'object' && result && result instanceof Result) return result;\n  } return new Result(false);\n};\n\niterate.stop = function (result) {\n  return new Result(true, result);\n};\n","var global = require('../internals/global');\nvar getOwnPropertyDescriptor = require('../internals/object-get-own-property-descriptor').f;\nvar classof = require('../internals/classof-raw');\nvar macrotask = require('../internals/task').set;\nvar IS_IOS = require('../internals/engine-is-ios');\n\nvar MutationObserver = global.MutationObserver || global.WebKitMutationObserver;\nvar process = global.process;\nvar Promise = global.Promise;\nvar IS_NODE = classof(process) == 'process';\n// Node.js 11 shows ExperimentalWarning on getting `queueMicrotask`\nvar queueMicrotaskDescriptor = getOwnPropertyDescriptor(global, 'queueMicrotask');\nvar queueMicrotask = queueMicrotaskDescriptor && queueMicrotaskDescriptor.value;\n\nvar flush, head, last, notify, toggle, node, promise, then;\n\n// modern engines have queueMicrotask method\nif (!queueMicrotask) {\n  flush = function () {\n    var parent, fn;\n    if (IS_NODE && (parent = process.domain)) parent.exit();\n    while (head) {\n      fn = head.fn;\n      head = head.next;\n      try {\n        fn();\n      } catch (error) {\n        if (head) notify();\n        else last = undefined;\n        throw error;\n      }\n    } last = undefined;\n    if (parent) parent.enter();\n  };\n\n  // Node.js\n  if (IS_NODE) {\n    notify = function () {\n      process.nextTick(flush);\n    };\n  // browsers with MutationObserver, except iOS - https://github.com/zloirock/core-js/issues/339\n  } else if (MutationObserver && !IS_IOS) {\n    toggle = true;\n    node = document.createTextNode('');\n    new MutationObserver(flush).observe(node, { characterData: true });\n    notify = function () {\n      node.data = toggle = !toggle;\n    };\n  // environments with maybe non-completely correct, but existent Promise\n  } else if (Promise && Promise.resolve) {\n    // Promise.resolve without an argument throws an error in LG WebOS 2\n    promise = Promise.resolve(undefined);\n    then = promise.then;\n    notify = function () {\n      then.call(promise, flush);\n    };\n  // for other environments - macrotask based on:\n  // - setImmediate\n  // - MessageChannel\n  // - window.postMessag\n  // - onreadystatechange\n  // - setTimeout\n  } else {\n    notify = function () {\n      // strange IE + webpack dev server bug - use .call(global)\n      macrotask.call(global, flush);\n    };\n  }\n}\n\nmodule.exports = queueMicrotask || function (fn) {\n  var task = { fn: fn, next: undefined };\n  if (last) last.next = task;\n  if (!head) {\n    head = task;\n    notify();\n  } last = task;\n};\n","var global = require('../internals/global');\n\nmodule.exports = global.Promise;\n","'use strict';\nvar aFunction = require('../internals/a-function');\n\nvar PromiseCapability = function (C) {\n  var resolve, reject;\n  this.promise = new C(function ($$resolve, $$reject) {\n    if (resolve !== undefined || reject !== undefined) throw TypeError('Bad Promise constructor');\n    resolve = $$resolve;\n    reject = $$reject;\n  });\n  this.resolve = aFunction(resolve);\n  this.reject = aFunction(reject);\n};\n\n// 25.4.1.5 NewPromiseCapability(C)\nmodule.exports.f = function (C) {\n  return new PromiseCapability(C);\n};\n","module.exports = function (exec) {\n  try {\n    return { error: false, value: exec() };\n  } catch (error) {\n    return { error: true, value: error };\n  }\n};\n","var anObject = require('../internals/an-object');\nvar isObject = require('../internals/is-object');\nvar newPromiseCapability = require('../internals/new-promise-capability');\n\nmodule.exports = function (C, x) {\n  anObject(C);\n  if (isObject(x) && x.constructor === C) return x;\n  var promiseCapability = newPromiseCapability.f(C);\n  var resolve = promiseCapability.resolve;\n  resolve(x);\n  return promiseCapability.promise;\n};\n","'use strict';\nvar getBuiltIn = require('../internals/get-built-in');\nvar definePropertyModule = require('../internals/object-define-property');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\nvar DESCRIPTORS = require('../internals/descriptors');\n\nvar SPECIES = wellKnownSymbol('species');\n\nmodule.exports = function (CONSTRUCTOR_NAME) {\n  var Constructor = getBuiltIn(CONSTRUCTOR_NAME);\n  var defineProperty = definePropertyModule.f;\n\n  if (DESCRIPTORS && Constructor && !Constructor[SPECIES]) {\n    defineProperty(Constructor, SPECIES, {\n      configurable: true,\n      get: function () { return this; }\n    });\n  }\n};\n","var global = require('../internals/global');\nvar fails = require('../internals/fails');\nvar classof = require('../internals/classof-raw');\nvar bind = require('../internals/function-bind-context');\nvar html = require('../internals/html');\nvar createElement = require('../internals/document-create-element');\nvar IS_IOS = require('../internals/engine-is-ios');\n\nvar location = global.location;\nvar set = global.setImmediate;\nvar clear = global.clearImmediate;\nvar process = global.process;\nvar MessageChannel = global.MessageChannel;\nvar Dispatch = global.Dispatch;\nvar counter = 0;\nvar queue = {};\nvar ONREADYSTATECHANGE = 'onreadystatechange';\nvar defer, channel, port;\n\nvar run = function (id) {\n  // eslint-disable-next-line no-prototype-builtins\n  if (queue.hasOwnProperty(id)) {\n    var fn = queue[id];\n    delete queue[id];\n    fn();\n  }\n};\n\nvar runner = function (id) {\n  return function () {\n    run(id);\n  };\n};\n\nvar listener = function (event) {\n  run(event.data);\n};\n\nvar post = function (id) {\n  // old engines have not location.origin\n  global.postMessage(id + '', location.protocol + '//' + location.host);\n};\n\n// Node.js 0.9+ & IE10+ has setImmediate, otherwise:\nif (!set || !clear) {\n  set = function setImmediate(fn) {\n    var args = [];\n    var i = 1;\n    while (arguments.length > i) args.push(arguments[i++]);\n    queue[++counter] = function () {\n      // eslint-disable-next-line no-new-func\n      (typeof fn == 'function' ? fn : Function(fn)).apply(undefined, args);\n    };\n    defer(counter);\n    return counter;\n  };\n  clear = function clearImmediate(id) {\n    delete queue[id];\n  };\n  // Node.js 0.8-\n  if (classof(process) == 'process') {\n    defer = function (id) {\n      process.nextTick(runner(id));\n    };\n  // Sphere (JS game engine) Dispatch API\n  } else if (Dispatch && Dispatch.now) {\n    defer = function (id) {\n      Dispatch.now(runner(id));\n    };\n  // Browsers with MessageChannel, includes WebWorkers\n  // except iOS - https://github.com/zloirock/core-js/issues/624\n  } else if (MessageChannel && !IS_IOS) {\n    channel = new MessageChannel();\n    port = channel.port2;\n    channel.port1.onmessage = listener;\n    defer = bind(port.postMessage, port, 1);\n  // Browsers with postMessage, skip WebWorkers\n  // IE8 has postMessage, but it's sync & typeof its postMessage is 'object'\n  } else if (\n    global.addEventListener &&\n    typeof postMessage == 'function' &&\n    !global.importScripts &&\n    !fails(post) &&\n    location.protocol !== 'file:'\n  ) {\n    defer = post;\n    global.addEventListener('message', listener, false);\n  // IE8-\n  } else if (ONREADYSTATECHANGE in createElement('script')) {\n    defer = function (id) {\n      html.appendChild(createElement('script'))[ONREADYSTATECHANGE] = function () {\n        html.removeChild(this);\n        run(id);\n      };\n    };\n  // Rest old browsers\n  } else {\n    defer = function (id) {\n      setTimeout(runner(id), 0);\n    };\n  }\n}\n\nmodule.exports = {\n  set: set,\n  clear: clear\n};\n","'use strict';\nvar $ = require('../internals/export');\nvar forEach = require('../internals/array-for-each');\n\n// `Array.prototype.forEach` method\n// https://tc39.github.io/ecma262/#sec-array.prototype.foreach\n$({ target: 'Array', proto: true, forced: [].forEach != forEach }, {\n  forEach: forEach\n});\n","var $ = require('../internals/export');\nvar lastIndexOf = require('../internals/array-last-index-of');\n\n// `Array.prototype.lastIndexOf` method\n// https://tc39.github.io/ecma262/#sec-array.prototype.lastindexof\n$({ target: 'Array', proto: true, forced: lastIndexOf !== [].lastIndexOf }, {\n  lastIndexOf: lastIndexOf\n});\n","'use strict';\nvar $ = require('../internals/export');\nvar $some = require('../internals/array-iteration').some;\nvar arrayMethodIsStrict = require('../internals/array-method-is-strict');\nvar arrayMethodUsesToLength = require('../internals/array-method-uses-to-length');\n\nvar STRICT_METHOD = arrayMethodIsStrict('some');\nvar USES_TO_LENGTH = arrayMethodUsesToLength('some');\n\n// `Array.prototype.some` method\n// https://tc39.github.io/ecma262/#sec-array.prototype.some\n$({ target: 'Array', proto: true, forced: !STRICT_METHOD || !USES_TO_LENGTH }, {\n  some: function some(callbackfn /* , thisArg */) {\n    return $some(this, callbackfn, arguments.length > 1 ? arguments[1] : undefined);\n  }\n});\n","'use strict';\nvar $ = require('../internals/export');\nvar IS_PURE = require('../internals/is-pure');\nvar global = require('../internals/global');\nvar getBuiltIn = require('../internals/get-built-in');\nvar NativePromise = require('../internals/native-promise-constructor');\nvar redefine = require('../internals/redefine');\nvar redefineAll = require('../internals/redefine-all');\nvar setToStringTag = require('../internals/set-to-string-tag');\nvar setSpecies = require('../internals/set-species');\nvar isObject = require('../internals/is-object');\nvar aFunction = require('../internals/a-function');\nvar anInstance = require('../internals/an-instance');\nvar classof = require('../internals/classof-raw');\nvar inspectSource = require('../internals/inspect-source');\nvar iterate = require('../internals/iterate');\nvar checkCorrectnessOfIteration = require('../internals/check-correctness-of-iteration');\nvar speciesConstructor = require('../internals/species-constructor');\nvar task = require('../internals/task').set;\nvar microtask = require('../internals/microtask');\nvar promiseResolve = require('../internals/promise-resolve');\nvar hostReportErrors = require('../internals/host-report-errors');\nvar newPromiseCapabilityModule = require('../internals/new-promise-capability');\nvar perform = require('../internals/perform');\nvar InternalStateModule = require('../internals/internal-state');\nvar isForced = require('../internals/is-forced');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\nvar V8_VERSION = require('../internals/engine-v8-version');\n\nvar SPECIES = wellKnownSymbol('species');\nvar PROMISE = 'Promise';\nvar getInternalState = InternalStateModule.get;\nvar setInternalState = InternalStateModule.set;\nvar getInternalPromiseState = InternalStateModule.getterFor(PROMISE);\nvar PromiseConstructor = NativePromise;\nvar TypeError = global.TypeError;\nvar document = global.document;\nvar process = global.process;\nvar $fetch = getBuiltIn('fetch');\nvar newPromiseCapability = newPromiseCapabilityModule.f;\nvar newGenericPromiseCapability = newPromiseCapability;\nvar IS_NODE = classof(process) == 'process';\nvar DISPATCH_EVENT = !!(document && document.createEvent && global.dispatchEvent);\nvar UNHANDLED_REJECTION = 'unhandledrejection';\nvar REJECTION_HANDLED = 'rejectionhandled';\nvar PENDING = 0;\nvar FULFILLED = 1;\nvar REJECTED = 2;\nvar HANDLED = 1;\nvar UNHANDLED = 2;\nvar Internal, OwnPromiseCapability, PromiseWrapper, nativeThen;\n\nvar FORCED = isForced(PROMISE, function () {\n  var GLOBAL_CORE_JS_PROMISE = inspectSource(PromiseConstructor) !== String(PromiseConstructor);\n  if (!GLOBAL_CORE_JS_PROMISE) {\n    // V8 6.6 (Node 10 and Chrome 66) have a bug with resolving custom thenables\n    // https://bugs.chromium.org/p/chromium/issues/detail?id=830565\n    // We can't detect it synchronously, so just check versions\n    if (V8_VERSION === 66) return true;\n    // Unhandled rejections tracking support, NodeJS Promise without it fails @@species test\n    if (!IS_NODE && typeof PromiseRejectionEvent != 'function') return true;\n  }\n  // We need Promise#finally in the pure version for preventing prototype pollution\n  if (IS_PURE && !PromiseConstructor.prototype['finally']) return true;\n  // We can't use @@species feature detection in V8 since it causes\n  // deoptimization and performance degradation\n  // https://github.com/zloirock/core-js/issues/679\n  if (V8_VERSION >= 51 && /native code/.test(PromiseConstructor)) return false;\n  // Detect correctness of subclassing with @@species support\n  var promise = PromiseConstructor.resolve(1);\n  var FakePromise = function (exec) {\n    exec(function () { /* empty */ }, function () { /* empty */ });\n  };\n  var constructor = promise.constructor = {};\n  constructor[SPECIES] = FakePromise;\n  return !(promise.then(function () { /* empty */ }) instanceof FakePromise);\n});\n\nvar INCORRECT_ITERATION = FORCED || !checkCorrectnessOfIteration(function (iterable) {\n  PromiseConstructor.all(iterable)['catch'](function () { /* empty */ });\n});\n\n// helpers\nvar isThenable = function (it) {\n  var then;\n  return isObject(it) && typeof (then = it.then) == 'function' ? then : false;\n};\n\nvar notify = function (promise, state, isReject) {\n  if (state.notified) return;\n  state.notified = true;\n  var chain = state.reactions;\n  microtask(function () {\n    var value = state.value;\n    var ok = state.state == FULFILLED;\n    var index = 0;\n    // variable length - can't use forEach\n    while (chain.length > index) {\n      var reaction = chain[index++];\n      var handler = ok ? reaction.ok : reaction.fail;\n      var resolve = reaction.resolve;\n      var reject = reaction.reject;\n      var domain = reaction.domain;\n      var result, then, exited;\n      try {\n        if (handler) {\n          if (!ok) {\n            if (state.rejection === UNHANDLED) onHandleUnhandled(promise, state);\n            state.rejection = HANDLED;\n          }\n          if (handler === true) result = value;\n          else {\n            if (domain) domain.enter();\n            result = handler(value); // can throw\n            if (domain) {\n              domain.exit();\n              exited = true;\n            }\n          }\n          if (result === reaction.promise) {\n            reject(TypeError('Promise-chain cycle'));\n          } else if (then = isThenable(result)) {\n            then.call(result, resolve, reject);\n          } else resolve(result);\n        } else reject(value);\n      } catch (error) {\n        if (domain && !exited) domain.exit();\n        reject(error);\n      }\n    }\n    state.reactions = [];\n    state.notified = false;\n    if (isReject && !state.rejection) onUnhandled(promise, state);\n  });\n};\n\nvar dispatchEvent = function (name, promise, reason) {\n  var event, handler;\n  if (DISPATCH_EVENT) {\n    event = document.createEvent('Event');\n    event.promise = promise;\n    event.reason = reason;\n    event.initEvent(name, false, true);\n    global.dispatchEvent(event);\n  } else event = { promise: promise, reason: reason };\n  if (handler = global['on' + name]) handler(event);\n  else if (name === UNHANDLED_REJECTION) hostReportErrors('Unhandled promise rejection', reason);\n};\n\nvar onUnhandled = function (promise, state) {\n  task.call(global, function () {\n    var value = state.value;\n    var IS_UNHANDLED = isUnhandled(state);\n    var result;\n    if (IS_UNHANDLED) {\n      result = perform(function () {\n        if (IS_NODE) {\n          process.emit('unhandledRejection', value, promise);\n        } else dispatchEvent(UNHANDLED_REJECTION, promise, value);\n      });\n      // Browsers should not trigger `rejectionHandled` event if it was handled here, NodeJS - should\n      state.rejection = IS_NODE || isUnhandled(state) ? UNHANDLED : HANDLED;\n      if (result.error) throw result.value;\n    }\n  });\n};\n\nvar isUnhandled = function (state) {\n  return state.rejection !== HANDLED && !state.parent;\n};\n\nvar onHandleUnhandled = function (promise, state) {\n  task.call(global, function () {\n    if (IS_NODE) {\n      process.emit('rejectionHandled', promise);\n    } else dispatchEvent(REJECTION_HANDLED, promise, state.value);\n  });\n};\n\nvar bind = function (fn, promise, state, unwrap) {\n  return function (value) {\n    fn(promise, state, value, unwrap);\n  };\n};\n\nvar internalReject = function (promise, state, value, unwrap) {\n  if (state.done) return;\n  state.done = true;\n  if (unwrap) state = unwrap;\n  state.value = value;\n  state.state = REJECTED;\n  notify(promise, state, true);\n};\n\nvar internalResolve = function (promise, state, value, unwrap) {\n  if (state.done) return;\n  state.done = true;\n  if (unwrap) state = unwrap;\n  try {\n    if (promise === value) throw TypeError(\"Promise can't be resolved itself\");\n    var then = isThenable(value);\n    if (then) {\n      microtask(function () {\n        var wrapper = { done: false };\n        try {\n          then.call(value,\n            bind(internalResolve, promise, wrapper, state),\n            bind(internalReject, promise, wrapper, state)\n          );\n        } catch (error) {\n          internalReject(promise, wrapper, error, state);\n        }\n      });\n    } else {\n      state.value = value;\n      state.state = FULFILLED;\n      notify(promise, state, false);\n    }\n  } catch (error) {\n    internalReject(promise, { done: false }, error, state);\n  }\n};\n\n// constructor polyfill\nif (FORCED) {\n  // 25.4.3.1 Promise(executor)\n  PromiseConstructor = function Promise(executor) {\n    anInstance(this, PromiseConstructor, PROMISE);\n    aFunction(executor);\n    Internal.call(this);\n    var state = getInternalState(this);\n    try {\n      executor(bind(internalResolve, this, state), bind(internalReject, this, state));\n    } catch (error) {\n      internalReject(this, state, error);\n    }\n  };\n  // eslint-disable-next-line no-unused-vars\n  Internal = function Promise(executor) {\n    setInternalState(this, {\n      type: PROMISE,\n      done: false,\n      notified: false,\n      parent: false,\n      reactions: [],\n      rejection: false,\n      state: PENDING,\n      value: undefined\n    });\n  };\n  Internal.prototype = redefineAll(PromiseConstructor.prototype, {\n    // `Promise.prototype.then` method\n    // https://tc39.github.io/ecma262/#sec-promise.prototype.then\n    then: function then(onFulfilled, onRejected) {\n      var state = getInternalPromiseState(this);\n      var reaction = newPromiseCapability(speciesConstructor(this, PromiseConstructor));\n      reaction.ok = typeof onFulfilled == 'function' ? onFulfilled : true;\n      reaction.fail = typeof onRejected == 'function' && onRejected;\n      reaction.domain = IS_NODE ? process.domain : undefined;\n      state.parent = true;\n      state.reactions.push(reaction);\n      if (state.state != PENDING) notify(this, state, false);\n      return reaction.promise;\n    },\n    // `Promise.prototype.catch` method\n    // https://tc39.github.io/ecma262/#sec-promise.prototype.catch\n    'catch': function (onRejected) {\n      return this.then(undefined, onRejected);\n    }\n  });\n  OwnPromiseCapability = function () {\n    var promise = new Internal();\n    var state = getInternalState(promise);\n    this.promise = promise;\n    this.resolve = bind(internalResolve, promise, state);\n    this.reject = bind(internalReject, promise, state);\n  };\n  newPromiseCapabilityModule.f = newPromiseCapability = function (C) {\n    return C === PromiseConstructor || C === PromiseWrapper\n      ? new OwnPromiseCapability(C)\n      : newGenericPromiseCapability(C);\n  };\n\n  if (!IS_PURE && typeof NativePromise == 'function') {\n    nativeThen = NativePromise.prototype.then;\n\n    // wrap native Promise#then for native async functions\n    redefine(NativePromise.prototype, 'then', function then(onFulfilled, onRejected) {\n      var that = this;\n      return new PromiseConstructor(function (resolve, reject) {\n        nativeThen.call(that, resolve, reject);\n      }).then(onFulfilled, onRejected);\n    // https://github.com/zloirock/core-js/issues/640\n    }, { unsafe: true });\n\n    // wrap fetch result\n    if (typeof $fetch == 'function') $({ global: true, enumerable: true, forced: true }, {\n      // eslint-disable-next-line no-unused-vars\n      fetch: function fetch(input /* , init */) {\n        return promiseResolve(PromiseConstructor, $fetch.apply(global, arguments));\n      }\n    });\n  }\n}\n\n$({ global: true, wrap: true, forced: FORCED }, {\n  Promise: PromiseConstructor\n});\n\nsetToStringTag(PromiseConstructor, PROMISE, false, true);\nsetSpecies(PROMISE);\n\nPromiseWrapper = getBuiltIn(PROMISE);\n\n// statics\n$({ target: PROMISE, stat: true, forced: FORCED }, {\n  // `Promise.reject` method\n  // https://tc39.github.io/ecma262/#sec-promise.reject\n  reject: function reject(r) {\n    var capability = newPromiseCapability(this);\n    capability.reject.call(undefined, r);\n    return capability.promise;\n  }\n});\n\n$({ target: PROMISE, stat: true, forced: IS_PURE || FORCED }, {\n  // `Promise.resolve` method\n  // https://tc39.github.io/ecma262/#sec-promise.resolve\n  resolve: function resolve(x) {\n    return promiseResolve(IS_PURE && this === PromiseWrapper ? PromiseConstructor : this, x);\n  }\n});\n\n$({ target: PROMISE, stat: true, forced: INCORRECT_ITERATION }, {\n  // `Promise.all` method\n  // https://tc39.github.io/ecma262/#sec-promise.all\n  all: function all(iterable) {\n    var C = this;\n    var capability = newPromiseCapability(C);\n    var resolve = capability.resolve;\n    var reject = capability.reject;\n    var result = perform(function () {\n      var $promiseResolve = aFunction(C.resolve);\n      var values = [];\n      var counter = 0;\n      var remaining = 1;\n      iterate(iterable, function (promise) {\n        var index = counter++;\n        var alreadyCalled = false;\n        values.push(undefined);\n        remaining++;\n        $promiseResolve.call(C, promise).then(function (value) {\n          if (alreadyCalled) return;\n          alreadyCalled = true;\n          values[index] = value;\n          --remaining || resolve(values);\n        }, reject);\n      });\n      --remaining || resolve(values);\n    });\n    if (result.error) reject(result.value);\n    return capability.promise;\n  },\n  // `Promise.race` method\n  // https://tc39.github.io/ecma262/#sec-promise.race\n  race: function race(iterable) {\n    var C = this;\n    var capability = newPromiseCapability(C);\n    var reject = capability.reject;\n    var result = perform(function () {\n      var $promiseResolve = aFunction(C.resolve);\n      iterate(iterable, function (promise) {\n        $promiseResolve.call(C, promise).then(capability.resolve, reject);\n      });\n    });\n    if (result.error) reject(result.value);\n    return capability.promise;\n  }\n});\n","var DESCRIPTORS = require('../internals/descriptors');\nvar global = require('../internals/global');\nvar isForced = require('../internals/is-forced');\nvar inheritIfRequired = require('../internals/inherit-if-required');\nvar defineProperty = require('../internals/object-define-property').f;\nvar getOwnPropertyNames = require('../internals/object-get-own-property-names').f;\nvar isRegExp = require('../internals/is-regexp');\nvar getFlags = require('../internals/regexp-flags');\nvar stickyHelpers = require('../internals/regexp-sticky-helpers');\nvar redefine = require('../internals/redefine');\nvar fails = require('../internals/fails');\nvar setInternalState = require('../internals/internal-state').set;\nvar setSpecies = require('../internals/set-species');\nvar wellKnownSymbol = require('../internals/well-known-symbol');\n\nvar MATCH = wellKnownSymbol('match');\nvar NativeRegExp = global.RegExp;\nvar RegExpPrototype = NativeRegExp.prototype;\nvar re1 = /a/g;\nvar re2 = /a/g;\n\n// \"new\" should create a new object, old webkit bug\nvar CORRECT_NEW = new NativeRegExp(re1) !== re1;\n\nvar UNSUPPORTED_Y = stickyHelpers.UNSUPPORTED_Y;\n\nvar FORCED = DESCRIPTORS && isForced('RegExp', (!CORRECT_NEW || UNSUPPORTED_Y || fails(function () {\n  re2[MATCH] = false;\n  // RegExp constructor can alter flags and IsRegExp works correct with @@match\n  return NativeRegExp(re1) != re1 || NativeRegExp(re2) == re2 || NativeRegExp(re1, 'i') != '/a/i';\n})));\n\n// `RegExp` constructor\n// https://tc39.github.io/ecma262/#sec-regexp-constructor\nif (FORCED) {\n  var RegExpWrapper = function RegExp(pattern, flags) {\n    var thisIsRegExp = this instanceof RegExpWrapper;\n    var patternIsRegExp = isRegExp(pattern);\n    var flagsAreUndefined = flags === undefined;\n    var sticky;\n\n    if (!thisIsRegExp && patternIsRegExp && pattern.constructor === RegExpWrapper && flagsAreUndefined) {\n      return pattern;\n    }\n\n    if (CORRECT_NEW) {\n      if (patternIsRegExp && !flagsAreUndefined) pattern = pattern.source;\n    } else if (pattern instanceof RegExpWrapper) {\n      if (flagsAreUndefined) flags = getFlags.call(pattern);\n      pattern = pattern.source;\n    }\n\n    if (UNSUPPORTED_Y) {\n      sticky = !!flags && flags.indexOf('y') > -1;\n      if (sticky) flags = flags.replace(/y/g, '');\n    }\n\n    var result = inheritIfRequired(\n      CORRECT_NEW ? new NativeRegExp(pattern, flags) : NativeRegExp(pattern, flags),\n      thisIsRegExp ? this : RegExpPrototype,\n      RegExpWrapper\n    );\n\n    if (UNSUPPORTED_Y && sticky) setInternalState(result, { sticky: sticky });\n\n    return result;\n  };\n  var proxy = function (key) {\n    key in RegExpWrapper || defineProperty(RegExpWrapper, key, {\n      configurable: true,\n      get: function () { return NativeRegExp[key]; },\n      set: function (it) { NativeRegExp[key] = it; }\n    });\n  };\n  var keys = getOwnPropertyNames(NativeRegExp);\n  var index = 0;\n  while (keys.length > index) proxy(keys[index++]);\n  RegExpPrototype.constructor = RegExpWrapper;\n  RegExpWrapper.prototype = RegExpPrototype;\n  redefine(global, 'RegExp', RegExpWrapper);\n}\n\n// https://tc39.github.io/ecma262/#sec-get-regexp-@@species\nsetSpecies('RegExp');\n","var global = require('../internals/global');\nvar DOMIterables = require('../internals/dom-iterables');\nvar forEach = require('../internals/array-for-each');\nvar createNonEnumerableProperty = require('../internals/create-non-enumerable-property');\n\nfor (var COLLECTION_NAME in DOMIterables) {\n  var Collection = global[COLLECTION_NAME];\n  var CollectionPrototype = Collection && Collection.prototype;\n  // some Chrome versions have non-configurable methods on DOMTokenList\n  if (CollectionPrototype && CollectionPrototype.forEach !== forEach) try {\n    createNonEnumerableProperty(CollectionPrototype, 'forEach', forEach);\n  } catch (error) {\n    CollectionPrototype.forEach = forEach;\n  }\n}\n"],"sourceRoot":""}